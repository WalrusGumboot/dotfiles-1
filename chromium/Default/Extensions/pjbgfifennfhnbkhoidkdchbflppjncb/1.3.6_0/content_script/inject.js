const CUSTOM_DOMAINS={ebay:".ebay.com",yahoo:"www.yahoo.",twitch:".twitch.tv",github:"github.com",docs:"docs.google.",bing:"www.bing.com",amazon:"www.amazon.",gmail:"mail.google.",tumblr:"www.tumblr.",twitter:"twitter.com",inbox:"inbox.google.",drive:"drive.google.",sites:"sites.google.",youtube:"www.youtube.",dropbox:"www.dropbox.",reddit:"www.reddit.com",maps:".google.com/maps/",facebook:"www.facebook.",wikipedia:"wikipedia.org",instagram:"www.instagram.",duckduckgo:"duckduckgo.com",stackoverflow:"stackoverflow.com",lostfilm:"lostfilm.tv"},HEAVY_RESOURCES=["facebook.com"];class Inject{constructor(){this.darkThemesAmount=34,this.tabHref=document.location.href,this.link=document.getElementById("dark-mode"),this.style=document.getElementById("dark-mode-custom-style"),this.themeChanger=document.getElementById("dark-mode-theme-changer-style"),this.htmlElement=document.documentElement,this.storage=null,this.run()}run(){this.hideElement(this.htmlElement),this.initListeners(),this.checkInsertedLinkExisting(),this.checkInsertedStyleExisting(),this.checkInsertedThemeChangerExisting(),this.createObserver(),window===window.top?this.update():chrome.runtime.sendMessage({message:"top"},()=>this.init())}initListeners(){this.initStorageListeners(),chrome.runtime.onMessage.addListener((a,b,c)=>("URLChanged"===a.action&&a.url!==this.tabHref&&(this.tabHref=a.url,this.update()),c(""),!0))}initStorageListeners(){chrome.storage.onChanged.addListener(a=>{const b=Object.keys(a);b.forEach(b=>this.storage[b]=a[b].newValue),this.update()})}checkInsertedLinkExisting(){this.link||(this.link=document.createElement("link"),this.link.setAttribute("type","text/css"),this.link.setAttribute("id","dark-mode"),this.link.setAttribute("rel","stylesheet"),this.htmlElement&&this.htmlElement.appendChild(this.link))}checkInsertedStyleExisting(){this.style||(this.style=document.createElement("style"),this.style.setAttribute("type","text/css"),this.style.setAttribute("id","dark-mode-custom-style"),this.htmlElement&&this.htmlElement.appendChild(this.style))}checkInsertedThemeChangerExisting(){this.themeChanger||(this.themeChanger=document.createElement("style"),this.themeChanger.setAttribute("type","text/css"),this.themeChanger.setAttribute("id","dark-mode-theme-changer-style"),this.htmlElement&&this.htmlElement.appendChild(this.themeChanger))}createObserver(){const a=new MutationObserver(function(){const b=document.getElementById("dark-mode");!b&&this.htmlElement&&this.htmlElement.appendChild(this.link),a.disconnect()});a.observe(document,{childList:!0,subtree:!0})}init(a){a&&(this.tabHref=a),this.update()}update(){let a=this.getDefaultStorageValuesObj();chrome.storage.local.get(a,a=>{this.storage||(this.storage=a);const b=this.getHostName(this.tabHref),c=a.whitePagesList.some(a=>this.tabHref.includes(a));if(c)return this.removeImportantNativeStyles(),this.edit("",""),this.setThemeChangerStyles(""),void setTimeout(()=>this.showElement(this.htmlElement),this.getDelayToShowHTML());const d=a.whitelist.some(a=>a===b);if(d)return this.removeImportantNativeStyles(),this.edit("",""),void setTimeout(()=>this.showElement(this.htmlElement),this.getDelayToShowHTML());let e=a.activeScheme?a.colorSchemes[a.activeScheme]:{bgColorHex:"#222222",textColor:"#eeeeee"};const f="dark"===a.state;for(let b in CUSTOM_DOMAINS){const c=a[b]&&this.tabHref.includes(CUSTOM_DOMAINS[b]);if(c){let a="";return f?a=chrome.runtime.getURL("/content_script/custom/"+b+".css"):(this.removeImportantNativeStyles(),this.setThemeChangerStyles("")),this.edit(a,""),void setTimeout(()=>this.showElement(this.htmlElement),this.getDelayToShowHTML())}}let g=this.getStoredDarkThemeId(a);if(!f)this.removeImportantNativeStyles(),this.setThemeChangerStyles(""),this.edit("","");else if(g){this.setThemeChangerStyles(a.activeScheme,e);const b=chrome.runtime.getURL("/content_script/general/dark_"+g+".css");34===g?chrome.storage.local.get({custom:""},function(a){this.removeImportantNativeStyles(),this.edit("",a.custom)}):(this.injectImportantNativeStyles(a.activeScheme,e),this.edit(b,""))}else this.removeImportantNativeStyles(),this.edit("","");setTimeout(()=>this.showElement(this.htmlElement),this.getDelayToShowHTML())})}getDefaultStorageValuesObj(){let a={};for(let b in CUSTOM_DOMAINS)a[b]=!0;for(let b=1;b<=this.darkThemesAmount;b++)a["dark_"+b]=!1;return a.dark_1=!0,a.whitelist=[],a.whitePagesList=[],a.state="light",a.colorSchemes={},a.activeScheme="",a}getStoredDarkThemeId(a){let b=null;for(let c=1;c<=this.darkThemesAmount;c++)if(a["dark_"+c]){b=c;break}return b}injectImportantNativeStyles(a="",b){let c=document.documentElement.querySelectorAll("*");for(let e=0;e<c.length;e++){if(getComputedStyle(c[e]).backgroundColor.match("rgba")){if("rgba(0, 0, 0, 0)"==getComputedStyle(c[e]).backgroundColor){this.addStyle(c[e],`background-color: rgba(0, 0, 0, 0) !important;`);continue}let a=getComputedStyle(c[e]).backgroundColor.replace(/rgba?\(\d{1,3}, ?\d{1,3}, ?\d{1,3}, ?/,"");if(a=a.replace(/\)/,""),.2>+a){this.addStyle(c[e],`background-color: rgba(0, 0, 0, 0) !important;`);continue}}var d=`background-color: ${b.bgColorHex} !important;`;"A"!==c[e].nodeName&&(d+=`color: ${b.textColor} !important;`),a&&("TH"===c[e].nodeName||"TD"===c[e].nodeName)&&(d+=`border-color: ${b.tableBorderColor} !important;`),this.addStyle(c[e],d)}}addStyle(a,b){let c=`${a.getAttribute("style")};`||"";a.setAttribute("style",`${c}/*startDM*/${b}/*endDM*/`)}setThemeChangerStyles(a="",b={}){if(!a)return void(this.themeChanger.textContent="");let c=`html, html *:not(a){color: ${b.textColor} !important; background-color: ${b.bgColorHex} !important;}`;c+=`html th, html td {border-color: ${b.tableBorderColor} !important;}`,this.themeChanger.textContent=c}removeImportantNativeStyles(){let a=document.documentElement.querySelectorAll("*");for(let b=0;b<a.length;b++)a[b].getAttribute("style")&&a[b].setAttribute("style",a[b].getAttribute("style").replace(/\/\*startDM\*\/.*\/*endDM\*\//g,""))}edit(a,b){this.link.setAttribute("href",a),this.style.textContent=b}getHostName(a){a=a.replace("www.","");let b=a.indexOf("//")+2;if(1<b){let c=a.indexOf("/",b);return 0<c?a.substring(b,c):(c=a.indexOf("?",b),0<c?a.substring(b,c):a.substring(b))}return a}showElement(a){a.classList.remove("hidden")}hideElement(a){a.classList.add("hidden")}getDelayToShowHTML(){const a=HEAVY_RESOURCES.some(a=>this.tabHref.includes(a));return a?200:100}}const inject=new Inject;