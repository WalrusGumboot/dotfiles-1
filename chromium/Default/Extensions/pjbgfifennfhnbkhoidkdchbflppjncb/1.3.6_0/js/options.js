class Options{constructor(){this.$tabLinks=document.querySelector(".button-list"),this.$sitesList=document.querySelector(".sites-list"),this.$pagesList=document.querySelector(".pages-list"),this.$domainInputField=document.querySelector(".input-field.domain"),this.$pageInputField=document.querySelector(".input-field.page"),this.$exclusionBtn=document.querySelector(".add-domain"),this.$exclusionPageBtn=document.querySelector(".add-page"),this.$schemesList=document.querySelector(".schemes-list"),this.$colorInputs=document.querySelectorAll(".color-input"),this.$saveSchemeBtn=document.querySelector(".save-scheme"),this.storage=null,this.initStorage=this.initStorage.bind(this),this.exclusionBtnClickHandler=this.exclusionBtnClickHandler.bind(this),this.renderWhiteList=this.renderWhiteList.bind(this),this.initListeners=this.initListeners.bind(this),this.deleteSiteHandler=this.deleteSiteHandler.bind(this),this.initColorPickerListeners=this.initColorPickerListeners.bind(this),this.createScheme=this.createScheme.bind(this),this.renderColorSchemes=this.renderColorSchemes.bind(this),this.renderScheme=this.renderScheme.bind(this),this.deleteSchemeHandler=this.deleteSchemeHandler.bind(this),this.schemeNameKeyUpHandler=this.schemeNameKeyUpHandler.bind(this),this.schemeNameBlurHandler=this.schemeNameBlurHandler.bind(this),this.activateScheme=this.activateScheme.bind(this),this.initStorage(),this.initListeners()}initListeners(){this.$tabLinks.addEventListener("click",this.tabsToggle),this.$exclusionBtn.addEventListener("click",this.exclusionBtnClickHandler),this.$domainInputField.addEventListener("keydown",a=>{13===a.keyCode&&(a.preventDefault(),this.exclusionBtnClickHandler(a))}),this.$exclusionPageBtn.addEventListener("click",this.exclusionBtnClickHandler),this.$pageInputField.addEventListener("keydown",a=>{13===a.keyCode&&(a.preventDefault(),this.exclusionBtnClickHandler(a))}),this.initColorPickerListeners(),this.$saveSchemeBtn.addEventListener("click",this.createScheme)}initStorage(){chrome.storage.local.get(a=>{this.storage=a,this.storage.whitelist||(this.storage.whitelist=[]),this.storage.whitePagesList||(this.storage.whitePagesList=[]),this.storage.colorSchemes||(this.storage.colorSchemes={}),this.storage.activeScheme||(this.storage.activeScheme=""),this.renderWhiteList(this.storage.whitelist,this.$sitesList),this.renderWhiteList(this.storage.whitePagesList,this.$pagesList),this.renderColorSchemes(this.storage.colorSchemes)})}tabsToggle(a){const b=a.target.dataset.name;if(!b)return;let c,d,e;for(d=document.getElementsByClassName("tab"),c=0;c<d.length;c++)d[c].classList.remove("active");for(e=document.getElementsByClassName("tablinks"),c=0;c<e.length;c++)e[c].classList.remove("active");document.getElementById(b).classList.add("active"),a.target.classList.add("active")}exclusionBtnClickHandler(a){const b=a.target.closest("#site-exclusion");b?this.excludeResourceFromBlackout("$domainInputField","whitelist","$sitesList"):this.excludeResourceFromBlackout("$pageInputField","whitePagesList","$pagesList")}excludeResourceFromBlackout(a,b,c){let d="$domainInputField"===a?this.getHostname(this[a].value):this[a].value;const e=this.isResourceDublicated(d,this.storage[b]),f="$domainInputField"===a?"site":"page";return this.isDomainCorrect(d)?void(d&&!e?(this.storage[b].push(d),chrome.storage.local.set({[b]:this.storage[b]},()=>{const b=this.createListItem(d);this[c].appendChild(b),this[a].value=""})):e&&(this[a].value=`This ${f} has been already added`)):void(this[a].value=`Invalid ${f}`)}createListItem(a){if(a){const b=document.createElement("li");b.textContent=a,b.classList.add("list-item"),b.dataset.name=a;const c=document.createElement("span");return c.classList.add("delete-icon"),c.addEventListener("click",this.deleteSiteHandler),b.appendChild(c),b}}renderWhiteList(a,b){if(a&&a.length)for(let c=0;c<a.length;c++)b.appendChild(this.createListItem(a[c]))}deleteSiteHandler(a){let b=a.target.closest("ul").classList.contains("sites-list")?"whitelist":"whitePagesList";let c=a.target.closest("li");const d=c.dataset.name;this.storage[b]=this.storage[b].filter(a=>a!==d),chrome.storage.local.set(this.storage,()=>{c.remove()})}isResourceDublicated(a,b){for(let c=0;c<b.length;c++)if(-1!==a.indexOf(b[c]))return!0;return!1}isDomainCorrect(a){return /(?!:\/\/)([a-zA-Z0-9-]+\.){0,5}[a-zA-Z0-9-][a-zA-Z0-9-]+\.[a-zA-Z]{2,64}?([^:\/\n?]?)/gi.test(a)}initColorPickerListeners(){for(let a=0,b=this.$colorInputs.length;a<b;++a)new CP(this.$colorInputs[a]).on("create",function(){this.source.onkeyup=()=>{this.set(this.source.value).enter()}}).on("change",function(a){const b=this.source.parentNode.querySelector(".color-preview");b.style.background=`#${a}`,this.source.value=`#${a}`})}createScheme(a){a.preventDefault();const b=this.findName(this.storage.colorSchemes||{},"theme"),c=this.getColorValues();chrome.runtime.sendMessage({message:"createScheme",schemeName:b,schemeParams:c},a=>{const b=this.renderScheme(a.schemeName);this.$schemesList.appendChild(b),this.storage.colorSchemes[a.schemeName]=a.schemeParams,this.activateScheme(a.schemeName)})}findName(a,b){var c,d=1;do c=b+"_"+d,d++;while(a[c]&&1e3>d);return c}getColorValues(){const a={};for(let b=0,c=this.$colorInputs.length;c>b;b++)a[this.$colorInputs[b].name]=this.$colorInputs[b].value;return a}renderColorSchemes(a){if(this.$schemesList.appendChild(this.renderScheme()),0!==Object.entries(a).length&&a.constructor===Object)for(let b in a)a.hasOwnProperty(b)&&this.$schemesList.appendChild(this.renderScheme(b))}renderScheme(a=""){const b=document.createElement("li");if(b.dataset.name=a,b.classList.add("list-item"),this.storage.activeScheme===a&&b.classList.add("active"),""!==a){const a=document.createElement("span");a.classList.add("delete-icon"),a.addEventListener("click",this.deleteSchemeHandler),b.appendChild(a)}const c=document.createElement("span");c.textContent=a?a:"Default theme",c.classList.add("scheme-name"),c.setAttribute("contentEditable",!!a),c.addEventListener("keydown",this.schemeNameKeyUpHandler),c.addEventListener("blur",this.schemeNameBlurHandler),b.appendChild(c);const d=document.createElement("span");return d.textContent="set",d.classList.add("activate-btn"),d.addEventListener("click",a=>{this.activateScheme(a.target.parentNode.dataset.name)}),b.appendChild(d),b}deleteSchemeHandler(a){let b=a.target.closest("li");const c=b.dataset.name,d=this.storage.activeScheme===c;chrome.runtime.sendMessage({message:"deleteScheme",schemeToDelete:c,isActive:d},a=>{this.storage.colorSchemes=a.colorSchemes,d&&this.activateScheme(),b.remove()})}schemeNameKeyUpHandler(a){const b=a.target.parentNode.dataset.name,c=this.storage.activeScheme===b,d=a.target.textContent;if(27==a.keyCode&&a.target.blur(),13==a.keyCode){if(a.preventDefault(),b===d||""===d)return void a.target.blur();const e=this.validateSchemeName(d);if(""!==e)return void(a.target.textContent=e);chrome.runtime.sendMessage({message:"renameScheme",prevSchemeName:b,newSchemeName:d},b=>{a.target.parentNode.dataset.name=b.schemeName,this.storage.colorSchemes=b.colorSchemes,c&&this.activateScheme(b.schemeName),a.target.blur()})}}validateSchemeName(a){let b="";return a in this.storage.colorSchemes&&(b="Name is already exists"),32<a.length&&(b="Name is too long"),b}schemeNameBlurHandler(a){a.target.textContent=a.target.parentNode.dataset.name}activateScheme(a=""){chrome.runtime.sendMessage({message:"setActiveScheme",schemeToActivate:a},b=>{this.storage.activeScheme=b.activeScheme,this.activateSchemeUI(a)})}activateSchemeUI(a){const b=this.$schemesList.getElementsByClassName("active"),c=this.$schemesList.querySelector(`[data-name="${a}"]`);0<b.length&&b[0].classList.remove("active"),c.classList.add("active")}getHostname(a){a=a.replace("www.","");var b=a.indexOf("//")+2;if(1<b){var c=a.indexOf("/",b);return 0<c?a.substring(b,c):(c=a.indexOf("?",b),0<c?a.substring(b,c):a.substring(b))}return a}}const o=new Options;